---
title: "Project-1-source-code"
output: html_document
date: "2024-04-02"
---
## Preparing task

Delete sth here

Use the library
```{r}
# All packages used in this script:
library(tidyverse)
library(here)
library(ggplot2)
library(dplyr)
library(ggrepel)
library(readr)
library(showtext)
```

Load the data 
```{r}
tornados <- read_csv("data/tornados.csv")

view(tornados)
```

** Common Utils **
Create a theme
```{r}
font_add_google("Montserrat", "Montserrat")
showtext_auto()
main_font = "Montserrat"

theme_1b <- function() {
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.major.y = element_line(color = "grey80"),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_line(color = "grey80"),
    panel.grid.minor.x = element_blank(),
    axis.title.x = element_text(size = 12, hjust = 0.5),
    axis.title.y = element_text(size = 12, hjust = 0.5),
  )
}
```

Color palette
```{r}
pal <- c('#00202e', '#003f5c', '#2c4875', '#8a508f', '#bc5090', '#ff6361', '#ff8531', '#ffa600', '#ffd380')
```

## Question 1

# Mini Question 1
```{r}
# ADD YOUR CODE
data <- tornados
```

# Mini Question 2
```{r}
data_1b <- data.frame(tornado_data)

data_1b$mag <- as.numeric(as.character(data_1b$mag))

yearly_count <- data_1b %>%
  group_by(yr) %>%
  summarise(TotalTornadoes = n())

# Define a function to calculate mode
get_mode <- function(v) {
  uniqv <- unique(na.omit(v))
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

# Summarizing the data by year
yearly_summary <- data_1b %>%
  group_by(yr) %>%
  summarise(
    AverageMag = mean(mag, na.rm = TRUE),
    AverageWidth = median(wid, na.rm = TRUE),
    AverageLength = median(len, na.rm = TRUE)
  )

special_year <- c(1974, 2011, 2020)

plot_occurrences <- ggplot(yearly_count, aes(x = yr, y = TotalTornadoes)) +
  geom_line(color = pal[2]) +
  geom_vline(xintercept = special_year, linetype = 2) +
  labs(title = "Total Yearly Tornado Occurrences",
       x = "Year",
       y = "Number of Tornadoes") +
  theme_minimal() +
  theme_1b()

# Creating three separate plots
plot_mag <- ggplot(yearly_summary, aes(x = yr, y = AverageMag)) +
  geom_line(color = pal[4]) +
  geom_vline(xintercept = special_year, linetype = 2) +
  annotate("text", x = 2011, y = 1.2, label = "2011 Super Outbreak", angle = 90, vjust = -0.5) +
  annotate("text", x = 1974, y = 0.8, label = "1974 Super Outbreak", angle = 90, vjust = -0.5) +
  annotate("text", x = 2020, y = 1.2, label = "2020 Easter Tornado Outbreak", angle = 90, vjust = -0.5) +
  labs(title = "Annual Changes in Average Tornado Magnitude",
       x = "Year",
       y = "Average Magnitude") +
  theme_minimal() +
  theme_1b()

plot_width <- ggplot(yearly_summary, aes(x = yr, y = AverageWidth)) +
  geom_line(color = pal[6]) +
    geom_vline(xintercept = special_year, linetype = 2) +
  labs(title = "Annual Changes in Average Tornado Width",
       x = "Year",
       y = "Average Width (yards)") +
  theme_minimal() +
  theme_1b()

plot_length <- ggplot(yearly_summary, aes(x = yr, y = AverageLength)) +
  geom_line(color = pal[8]) +
  geom_vline(xintercept = special_year, linetype = 2) +
  labs(title = "Annual Changes in Average Tornado Length",
       x = "Year",
       y = "Average Length (miles)") +
  theme_minimal() +
  theme_1b()

# Arranging the plots in a grid
grid.arrange(plot_occurrences, plot_mag, plot_width, plot_length, ncol = 1)

# Combine the plots
combined_plot <- plot_occurrences / plot_mag / plot_width / plot_length 

# Save the combined plot as a single image
ggsave("combined_plots_2.png", combined_plot, width = 10, height = 15, dpi = 300, bg = "white")
```

```

## Question 2

# Mini Question 1

```{r}
# Combine operations into one
combined_data <- tornados %>%
  select(st, om, fat, inj) %>%
  group_by(st) %>%
  summarise(number_of_tornados = n(),
            number_of_injuries = sum(inj, na.rm = TRUE),
            number_of_fatalities = sum(fat, na.rm = TRUE),
            fatality_rate = number_of_fatalities / number_of_tornados) %>%
  filter(fatality_rate > 0.1, st != "AL") |>
  arrange(desc(fatality_rate)) 

view(combined_data)
```

```{r}
combined_data <- combined_data %>%
  mutate(tornado_color_factor = case_when(
    number_of_tornados < 1000  ~ "0-999",
    number_of_tornados >= 1000 & number_of_tornados < 2000 ~ "1000-1999",
    number_of_tornados >= 2000 & number_of_tornados < 3000 ~ "2000-2999",
    number_of_tornados >= 3000 & number_of_tornados < 4000 ~ "3000-3999",
    TRUE ~ "4000+"
  ))

view(combined_data)
```

```{r}

colors <- c("0-999" = "lightblue", "1000-1999" = "darkgreen", "2000-2999" = "darkorange", "3000-3999" = "grey", "4000+" = "red")

# Create the bubble chart
bubble_chart <- ggplot(combined_data, aes(x = number_of_fatalities, y = number_of_injuries, size = number_of_tornados, color = tornado_color_factor)) +
  geom_point(alpha = 0.6) +
  #scale_x_log10() +  
  #scale_y_log10() + 
  scale_x_continuous(limits = c(0,600), breaks = seq(0,600,100)) +
  scale_y_continuous(limits = c(0,9500), breaks = seq(0,9500,2000)) +
  scale_size_continuous(name = "Number of tornados", range = c(3,12)) +
  scale_color_manual(values = colors,
                     labels = c("0-999" = "0-999", "1000-1999" = "1000-1999", "2000-2999" = "2000-2999", "3000-3999" = "3000-3999"),
                     name = "Tornado Range") + 
  geom_label_repel(aes(label = st), size = 3, nudge_x = 1, nudge_y = 1, na.rm = TRUE, show.legend = FALSE) + 
  labs(x = "Number of Fatalities", y = "Number of Injuries", title = "Number of Fatalities vs. Number of Injuries") +
  guides(color = guide_legend(override.aes = list(size = 4))) + 
  theme_minimal() +
  theme_1b() +
  theme (
    #legend.position = ""
  ) 

# Display the plot
bubble_chart
```


## Mini Question 2

```{r}
# ADD YOUR CODE


```